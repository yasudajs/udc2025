# データベース設計（UDC2025）

最終更新日: 2025-10-18

## 1. 方針
- 文字コード: utf8mb4
- タイムゾーン: JST（DBはUTC+アプリで変換でも可）
- 命名規約: snake_case, 単数テーブル名/複数テーブル名（選択）
 - 初期はDB必須ではないため、JSONファイルキャッシュ（TTL=24h）を第一選択とする。
 - 規模/要件次第でSQLite→MySQLへ段階的に移行可能な設計とする。

## 2. キャッシュ/永続化の選択肢
- JSONファイル（初期）
  - 構造: category（aed/evacuation_space/public_toilet）× municipality または bbox/hash 単位で保存
  - 格納項目: 取得時刻（fetched_at）、TTL、標準化データ配列
  - 長所: 実装が容易、Python3.7で運用容易
  - 短所: 同時更新・検索性に弱い

- SQLite（小〜中規模）
  - 長所: 単一ファイルで検索/インデックス、運用容易
  - 短所: 同時書き込みに弱い、スケールに限界

- MySQL（中規模以上）
  - 長所: 同時アクセス/インデックス最適化が可能
  - 短所: セットアップ・運用コスト

## 3. ER図（プレースホルダ）
- ER図は後日追加

## 4. テーブル定義テンプレ
### T_XX: テーブル名
- 目的: 
- カラム:
  | 物理名 | 論理名 | 型 | PK | NN | UQ | デフォルト | 備考 |
  |--------|--------|----|----|----|----|------------|------|
  | id | ID | BIGINT | ○ | ○ |  | AUTO_INCREMENT |
  | created_at | 作成日時 | DATETIME |  | ○ |  | CURRENT_TIMESTAMP |
  | updated_at | 更新日時 | DATETIME |  | ○ |  | CURRENT_TIMESTAMP on update CURRENT_TIMESTAMP |

## 5. インデックス/パーティション
- 必要に応じて記載

## 6. マイグレーション方針
- 初期DDL/差分の管理方法（手動SQL/ツール等）

## 7. 具体案（ドラフト）

### 7.1 JSONキャッシュ（初期採用）
- 保存先例: data/cache/<category>/<municipality>.json
- フォーマット例:
```jsonc
{
  "category": "public_toilet",
  "municipality": "福岡市",
  "fetched_at": "2025-10-18T12:00:00Z",
  "ttl_hours": 24,
  "items": [ { /* 標準化モデル */ } ]
}
```
- 失効条件: 現在時刻 - fetched_at > ttl → 取得し直し
- 優先取得順: 公衆トイレ > 避難所 > AED（ユーザー操作に応じてLazy取得）

### 7.2 SQLite案（将来）
テーブル: places
| カラム | 型 | 備考 |
|---|---|---|
| id | TEXT | PK（apiname+元IDをハッシュ化可） |
| category | TEXT | aed/evacuation_space/public_toilet |
| name | TEXT |  |
| address | TEXT |  |
| lat | REAL |  |
| lng | REAL |  |
| municipality | TEXT |  |
| updated_at | TEXT | ISO8601 |
| raw_json | TEXT | 原文の一部 |
インデックス: (category, municipality), (lat, lng)

### 7.3 MySQL案（将来）
- スキーマはSQLiteと同様、型/インデックス調整。
- MySQL 8.0のGIS機能（POINT, SPATIAL INDEX）の利用を検討。

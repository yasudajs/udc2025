# リファクタリング仕様書

## 概要

### 目的
- コードの保守性・可読性向上
- 機能分割による責任分離
- 設定の一元管理
- 段階的移行によるリスク低減

### 背景
現在のコードベース（map.js約500行、style.css相当量）において、複数の機能が1つのファイルに混在しており、保守性が低下しているため、リファクタリングを実施する。

### 対象範囲
- JavaScriptコードの機能分割
- 設定値の一元管理
- CSSのコンポーネント別分割
- モジュール化による依存関係整理

## 現状分析

### 問題点
- `map.js`: 地図初期化、現在地処理、API連携、マーカー管理、UI制御が混在
- `style.css`: レイアウト、コンポーネント、地図関連スタイルが混在
- 設定値のハードコーディング（デフォルト座標、API設定、タイムアウト値など）
- 単一ファイル依存による保守性の低下

### 規模
- JavaScript: 約500行
- CSS: 相当量
- 機能: 地図表示、現在地取得、施設検索、UI制御

## 目標構造

### JavaScriptモジュール構成
```
📁 static/js/
├── config.js          # 設定ファイル
├── app.js             # メインエントリーポイント
├── map-core.js        # 地図初期化・基本設定
├── location.js        # 現在地機能
├── markers.js         # マーカー管理
├── api.js             # API連携
├── ui.js              # UI制御
└── utils.js           # ユーティリティ
```

### CSS構成
```
📁 static/css/
├── base.css           # リセット・基本スタイル
├── layout.css         # レイアウト関連
├── map.css            # 地図関連スタイル
└── components.css     # コンポーネント別スタイル
```

### 設定ファイル構造
```javascript
export const CONFIG = {
  map: { defaultCenter, zoom, minZoom, maxZoom },
  api: { baseUrl, searchRadius, maxResults, endpoints },
  ui: { markerColors, notifications },
  geolocation: { timeout, enableHighAccuracy, maximumAge }
};
```

## 段階的移行プラン

### フェーズ1: 設定ファイル作成 + 基本構造準備
**目標**: 設定の一元化とモジュール化の基盤作り
**作業内容**:
- `config.js`作成（全設定値を移動）
- `utils.js`作成（共通関数移動）
- 既存`map.js`で設定を`config.js`から読み込み
**確認項目**: 地図表示、基本機能正常動作

### フェーズ2: コア機能の分離
**目標**: 地図初期化機能を独立化
**作業内容**:
- `map-core.js`作成
- `initMap()`関数を移動
- `setupMapLayers()`関数を移動
**確認項目**: 地図表示、ズーム・移動機能

### フェーズ3: 現在地機能の分離
**目標**: 位置情報関連機能を独立化
**作業内容**:
- `location.js`作成
- `showCurrentLocation()`, `addCurrentLocationMarker()`を移動
- 位置情報取得ロジックを移動
**確認項目**: 初期現在地表示、現在地ボタン機能

### フェーズ4: マーカー・API機能の分離
**目標**: データ表示機能を独立化
**作業内容**:
- `markers.js`作成（マーカー管理）
- `api.js`作成（BODIK API連携）
- `displayMarkers()`, `loadDataForCurrentCategory()`を移動
**確認項目**: カテゴリ別施設表示、データ読み込み

### フェーズ5: UI機能の分離
**目標**: UI制御機能を独立化
**作業内容**:
- `ui.js`作成（通知、ローディング、イベント）
- イベントリスナー、通知機能を移動
**確認項目**: 全UI操作、通知表示

### フェーズ6: メインエントリーポイント整理
**目標**: モジュール統合とクリーンアップ
**作業内容**:
- `app.js`作成（メインエントリーポイント）
- 各モジュールのインポートと初期化
- 古い`map.js`を削除
**確認項目**: 全機能正常動作

### フェーズ7: CSS分割
**目標**: スタイルの分割
**作業内容**:
- `base.css`, `layout.css`, `map.css`, `components.css`作成
- 既存`style.css`から適切に分配
**確認項目**: レイアウト・デザイン正常表示

## 品質チェック

### 必須確認項目（各フェーズ後）
- ✅ 地図表示（OpenStreetMapタイル読み込み）
- ✅ 現在地機能（初期表示・ボタンクリック）
- ✅ カテゴリ別施設表示（AED、病院、WiFiなど）
- ✅ ズーム・移動操作（地図操作）
- ✅ 通知・ローディング表示（UIフィードバック）
- ✅ コンソールエラーなし

### ブラウザ互換性確認
- Chrome/Edge: メインターゲット
- Firefox: 副次確認
- Safari: 最低限確認

## リスク対策

### 技術的対策
- **ES6 Modules**: モジュール分割に使用
- **段階的移行**: 1フェーズ1-2ファイルに限定
- **バックアップ**: 各フェーズ前に`git commit`
- **ロールバック**: 問題発生時は前のコミットに戻す

### 品質対策
- **動作確認**: 各フェーズ完了時に全機能テスト
- **分割コミット**: 変更を小さく保つ
- **ドキュメント**: 各モジュールのREADME記載

### 問題発生時の対応
1. 即座に作業中断
2. 前の安定版コミットに戻す
3. 問題分析・修正
4. 小規模修正で再開

## 完了条件

### 機能要件
- [ ] 全既存機能が正常動作
- [ ] パフォーマンス劣化なし
- [ ] ブラウザ互換性維持

### 構造要件
- [ ] JavaScript: 8モジュールに分割
- [ ] CSS: 4ファイルに分割
- [ ] 設定: config.jsに一元化
- [ ] 循環依存なし

### 品質要件
- [ ] 各フェーズで品質チェック通過
- [ ] コンソールエラーなし
- [ ] コードレビュー完了

## 見積もり

### 期間
- 全フェーズ: 約2-3日（1フェーズ1-2時間）
- テスト含む: 各フェーズ30分

### 工数
- 設計: 1時間
- 実装: 8-12時間
- テスト: 4-6時間
- 合計: 13-19時間

## 参考資料

- 01_要件定義.md
- 02_機能仕様.md
- 03_画面設計.md
- 06_API連携仕様.md

---

**作成日**: 2025年10月21日
**最終更新**: 2025年10月21日
**担当**: リファクタリングチーム